#!/bin/bash

# Pre-commit hook for code quality checks
# Runs phpcs on staged PHP files based on project type (drupal/wordpress)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# Get project root (where .git is located)
PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)

if [ -z "$PROJECT_ROOT" ]; then
    echo -e "${RED}Error: Not a git repository${NC}"
    exit 1
fi

CONFIG_FILE="$PROJECT_ROOT/config.yml"

# Check if config.yml exists
if [ ! -f "$CONFIG_FILE" ]; then
    # No config file, skip phpcs checks
    exit 0
fi

# Read project type from config.yml
PROJECT_TYPE=$(grep -E "^type:" "$CONFIG_FILE" | sed 's/type:[[:space:]]*//' | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')

if [ -z "$PROJECT_TYPE" ]; then
    exit 0
fi

# Get staged PHP files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(php|module|inc|install|theme|profile)$')

if [ -z "$STAGED_FILES" ]; then
    # No PHP files staged, skip
    exit 0
fi

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to find phpcs binary
find_phpcs() {
    # Check in vendor/bin first (local installation)
    if [ -f "$PROJECT_ROOT/vendor/bin/phpcs" ]; then
        echo "$PROJECT_ROOT/vendor/bin/phpcs"
        return 0
    fi

    # Check global installation
    if command_exists phpcs; then
        echo "phpcs"
        return 0
    fi

    return 1
}

# Function to install Drupal coding standards
install_drupal_standards() {
    echo -e "${BLUE}Installing Drupal coding standards...${NC}"

    if [ ! -f "$PROJECT_ROOT/composer.json" ]; then
        echo -e "${RED}Error: composer.json not found. Cannot install drupal/coder.${NC}"
        return 1
    fi

    cd "$PROJECT_ROOT" || exit 1

    # Install drupal/coder
    if ! composer require --dev drupal/coder 2>/dev/null; then
        echo -e "${RED}Error: Failed to install drupal/coder${NC}"
        return 1
    fi

    # Register Drupal standards with phpcs
    PHPCS_BIN=$(find_phpcs)
    if [ -n "$PHPCS_BIN" ]; then
        $PHPCS_BIN --config-set installed_paths "$PROJECT_ROOT/vendor/drupal/coder/coder_sniffer" 2>/dev/null
    fi

    echo -e "${GREEN}Drupal coding standards installed successfully${NC}"
    return 0
}

# Function to check if Drupal standards are available
check_drupal_standards() {
    PHPCS_BIN=$(find_phpcs)
    if [ -z "$PHPCS_BIN" ]; then
        return 1
    fi

    $PHPCS_BIN -i 2>/dev/null | grep -q "Drupal"
    return $?
}

# Function to install WordPress coding standards
install_wordpress_standards() {
    echo -e "${BLUE}Installing WordPress coding standards...${NC}"

    if [ ! -f "$PROJECT_ROOT/composer.json" ]; then
        echo -e "${RED}Error: composer.json not found. Cannot install wp-coding-standards.${NC}"
        return 1
    fi

    cd "$PROJECT_ROOT" || exit 1

    # Install WordPress coding standards
    if ! composer require --dev wp-coding-standards/wpcs dealerdirect/phpcodesniffer-composer-installer 2>/dev/null; then
        echo -e "${RED}Error: Failed to install WordPress coding standards${NC}"
        return 1
    fi

    echo -e "${GREEN}WordPress coding standards installed successfully${NC}"
    return 0
}

# Function to check if WordPress standards are available
check_wordpress_standards() {
    PHPCS_BIN=$(find_phpcs)
    if [ -z "$PHPCS_BIN" ]; then
        return 1
    fi

    $PHPCS_BIN -i 2>/dev/null | grep -q "WordPress"
    return $?
}

# Determine standard based on project type
case "$PROJECT_TYPE" in
    drupal)
        STANDARD="Drupal,DrupalPractice"
        CHECK_FUNC="check_drupal_standards"
        INSTALL_FUNC="install_drupal_standards"
        ;;
    wordpress)
        STANDARD="WordPress"
        CHECK_FUNC="check_wordpress_standards"
        INSTALL_FUNC="install_wordpress_standards"
        ;;
    *)
        # Unknown project type, skip
        exit 0
        ;;
esac

# Find or install phpcs
PHPCS_BIN=$(find_phpcs)

if [ -z "$PHPCS_BIN" ]; then
    echo -e "${YELLOW}phpcs not found. Installing...${NC}"
    cd "$PROJECT_ROOT" || exit 1
    composer require --dev squizlabs/php_codesniffer 2>/dev/null
    PHPCS_BIN=$(find_phpcs)

    if [ -z "$PHPCS_BIN" ]; then
        echo -e "${RED}Error: Could not install phpcs${NC}"
        exit 1
    fi
fi

# Check if standards are installed
if ! $CHECK_FUNC; then
    $INSTALL_FUNC
    if ! $CHECK_FUNC; then
        echo -e "${RED}Error: Could not configure coding standards${NC}"
        exit 1
    fi
fi

# Run phpcs on staged files
echo -e "${BLUE}Running phpcs with ${STANDARD} standard...${NC}"
echo ""

ERRORS_FOUND=0
FILES_CHECKED=0

for FILE in $STAGED_FILES; do
    if [ -f "$PROJECT_ROOT/$FILE" ]; then
        FILES_CHECKED=$((FILES_CHECKED + 1))

        # Run phpcs on the file
        OUTPUT=$($PHPCS_BIN --standard="$STANDARD" --colors "$PROJECT_ROOT/$FILE" 2>&1)
        RESULT=$?

        if [ $RESULT -ne 0 ]; then
            ERRORS_FOUND=1
            echo "$OUTPUT"
            echo ""
        fi
    fi
done

if [ $ERRORS_FOUND -eq 1 ]; then
    echo ""
    echo -e "${RED}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║${NC}  ${BOLD}❌ COMMIT REJECTED${NC}                                          ${RED}║${NC}"
    echo -e "${RED}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}Please fix the coding standard violations above.${NC}"
    echo ""
    echo -e "${CYAN}Tips:${NC}"
    echo -e "  ${DIM}•${NC} Run ${GREEN}phpcbf${NC} to auto-fix some issues:"
    echo -e "    ${DIM}\$${NC} ./vendor/bin/phpcbf --standard=${STANDARD} <file>"
    echo ""
    exit 1
fi

if [ $FILES_CHECKED -gt 0 ]; then
    echo -e "${GREEN}✓ All $FILES_CHECKED file(s) passed ${STANDARD} coding standards${NC}"
fi

exit 0
