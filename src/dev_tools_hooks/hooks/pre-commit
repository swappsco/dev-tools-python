#!/bin/bash

# Pre-commit hook for code quality checks
# Runs custom commands from .dev-hooks.yml (lint, type check, format, etc.)

# Colors optimized for macOS Terminal
RED='\x1b[31m'
GREEN='\x1b[32m'
YELLOW='\x1b[33m'
BLUE='\x1b[34m'
MAGENTA='\x1b[35m'
CYAN='\x1b[36m'
WHITE='\x1b[37m'
BOLD='\x1b[1m'
DIM='\x1b[2m'
NC='\x1b[0m'

# Get project root (where .git is located)
PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)

if [ -z "$PROJECT_ROOT" ]; then
    echo -e "${RED}Error: Not a git repository${NC}"
    exit 1
fi

CONFIG_FILE="$PROJECT_ROOT/.dev-hooks.yml"

# ============================================================================
# YAML Parser (simple, no dependencies)
# ============================================================================

yaml_get() {
    local key="$1"
    local file="$2"

    if [ ! -f "$file" ]; then
        echo ""
        return
    fi

    if [[ "$key" == *"."* ]]; then
        local parent="${key%%.*}"
        local child="${key#*.}"
        awk -v parent="$parent" -v child="$child" '
            $0 ~ "^"parent":" { in_section=1; next }
            in_section && /^[a-zA-Z]/ { in_section=0 }
            in_section && $0 ~ "^  "child":" {
                gsub(/^  [a-zA-Z_-]+:[ ]*/, "")
                gsub(/^["'\'']|["'\'']$/, "")
                gsub(/^[ \t]+|[ \t]+$/, "")
                print
                exit
            }
        ' "$file"
    else
        awk -v key="$key" '
            $0 ~ "^"key":" {
                gsub(/^[a-zA-Z_-]+:[ ]*/, "")
                gsub(/^["'\'']|["'\'']$/, "")
                gsub(/^[ \t]+|[ \t]+$/, "")
                print
                exit
            }
        ' "$file"
    fi
}

yaml_get_commands() {
    local section="$1"
    local file="$2"

    if [ ! -f "$file" ]; then
        return
    fi

    awk -v section="$section" '
        $0 ~ "^"section":" { in_section=1; next }
        in_section && /^[a-zA-Z]/ { in_section=0 }
        in_section && /^  commands:/ { in_commands=1; next }
        in_commands && /^  [a-zA-Z]/ { in_commands=0 }
        in_commands && /^    - name:/ {
            gsub(/^    - name:[ ]*/, "")
            gsub(/^["'\'']|["'\'']$/, "")
            name=$0
        }
        in_commands && /^      run:/ {
            gsub(/^      run:[ ]*/, "")
            gsub(/^["'\'']|["'\'']$/, "")
            print name "|" $0
        }
    ' "$file"
}

# ============================================================================
# Run Commands from .dev-hooks.yml
# ============================================================================

run_commands() {
    if [ ! -f "$CONFIG_FILE" ]; then
        # No config file, nothing to do
        exit 0
    fi

    # Check if pre-commit is enabled
    local enabled=$(yaml_get "pre-commit.enabled" "$CONFIG_FILE")
    if [ "$enabled" = "false" ]; then
        exit 0
    fi

    # Check docker settings
    local docker_enabled=$(yaml_get "docker.enabled" "$CONFIG_FILE")
    local docker_compose=$(yaml_get "docker.compose" "$CONFIG_FILE")
    local docker_container=$(yaml_get "docker.container" "$CONFIG_FILE")
    local compose_file=$(yaml_get "docker.compose_file" "$CONFIG_FILE")

    [ -z "$compose_file" ] && compose_file="docker-compose.yml"

    # Get commands
    local commands=$(yaml_get_commands "pre-commit" "$CONFIG_FILE")

    if [ -z "$commands" ]; then
        exit 0
    fi

    echo ""
    echo -e "${CYAN}${BOLD}┌──────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${CYAN}${BOLD}│  Running pre-commit checks...                                │${NC}"
    echo -e "${CYAN}${BOLD}└──────────────────────────────────────────────────────────────┘${NC}"
    echo ""

    local failed=0

    while IFS= read -r line; do
        [ -z "$line" ] && continue

        local name="${line%%|*}"
        local cmd="${line#*|}"

        echo -e "${BLUE}▶${NC} ${WHITE}${BOLD}${name}${NC}"
        echo -e "  ${DIM}${cmd}${NC}"

        # Build the actual command
        local full_cmd="$cmd"

        if [ "$docker_enabled" = "true" ]; then
            if [ "$docker_compose" = "true" ]; then
                full_cmd="docker-compose -f $compose_file exec -T $docker_container $cmd"
            else
                full_cmd="docker exec $docker_container $cmd"
            fi
        fi

        # Run command
        cd "$PROJECT_ROOT" || exit 1

        if eval "$full_cmd"; then
            echo -e "  ${GREEN}✔ Passed${NC}"
        else
            echo -e "  ${RED}✖ Failed${NC}"
            failed=1
        fi
        echo ""

    done <<< "$commands"

    if [ $failed -eq 1 ]; then
        echo -e "${RED}${BOLD}┌──────────────────────────────────────────────────────────────┐${NC}"
        echo -e "${RED}${BOLD}│  ✖ COMMIT REJECTED - Pre-commit checks failed                │${NC}"
        echo -e "${RED}${BOLD}└──────────────────────────────────────────────────────────────┘${NC}"
        echo ""
        echo -e "${YELLOW}Fix the issues above and try again.${NC}"
        echo ""
        exit 1
    fi

    echo -e "${GREEN}${BOLD}✔ All pre-commit checks passed${NC}"
    echo ""
}

# ============================================================================
# Main
# ============================================================================

run_commands
exit 0
