#!/bin/bash

# Pre-commit hook for code quality checks
# 1. Runs custom commands from .dev-hooks.yml (lint, type check, etc.)
# 2. Runs PHPCS on staged PHP files for Drupal/WordPress projects

# Colors optimized for macOS Terminal
RED='\x1b[31m'
GREEN='\x1b[32m'
YELLOW='\x1b[33m'
BLUE='\x1b[34m'
MAGENTA='\x1b[35m'
CYAN='\x1b[36m'
WHITE='\x1b[37m'
BOLD='\x1b[1m'
DIM='\x1b[2m'
NC='\x1b[0m'

# Get project root (where .git is located)
PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)

if [ -z "$PROJECT_ROOT" ]; then
    echo -e "${RED}Error: Not a git repository${NC}"
    exit 1
fi

HOOKS_CONFIG="$PROJECT_ROOT/.dev-hooks.yml"
PHP_CONFIG="$PROJECT_ROOT/config.yml"

# ============================================================================
# YAML Parser (simple, no dependencies)
# ============================================================================

yaml_get() {
    local key="$1"
    local file="$2"

    if [ ! -f "$file" ]; then
        echo ""
        return
    fi

    if [[ "$key" == *"."* ]]; then
        local parent="${key%%.*}"
        local child="${key#*.}"
        awk -v parent="$parent" -v child="$child" '
            $0 ~ "^"parent":" { in_section=1; next }
            in_section && /^[a-zA-Z]/ { in_section=0 }
            in_section && $0 ~ "^  "child":" {
                gsub(/^  [a-zA-Z_-]+:[ ]*/, "")
                gsub(/^["'\'']|["'\'']$/, "")
                gsub(/^[ \t]+|[ \t]+$/, "")
                print
                exit
            }
        ' "$file"
    else
        awk -v key="$key" '
            $0 ~ "^"key":" {
                gsub(/^[a-zA-Z_-]+:[ ]*/, "")
                gsub(/^["'\'']|["'\'']$/, "")
                gsub(/^[ \t]+|[ \t]+$/, "")
                print
                exit
            }
        ' "$file"
    fi
}

yaml_get_commands() {
    local section="$1"
    local file="$2"

    if [ ! -f "$file" ]; then
        return
    fi

    awk -v section="$section" '
        $0 ~ "^"section":" { in_section=1; next }
        in_section && /^[a-zA-Z]/ { in_section=0 }
        in_section && /^  commands:/ { in_commands=1; next }
        in_commands && /^  [a-zA-Z]/ { in_commands=0 }
        in_commands && /^    - name:/ {
            gsub(/^    - name:[ ]*/, "")
            gsub(/^["'\'']|["'\'']$/, "")
            name=$0
        }
        in_commands && /^      run:/ {
            gsub(/^      run:[ ]*/, "")
            gsub(/^["'\'']|["'\'']$/, "")
            print name "|" $0
        }
    ' "$file"
}

# ============================================================================
# Custom Commands from .dev-hooks.yml
# ============================================================================

run_custom_commands() {
    if [ ! -f "$HOOKS_CONFIG" ]; then
        return 0
    fi

    # Check if pre-commit is enabled
    local enabled=$(yaml_get "pre-commit.enabled" "$HOOKS_CONFIG")
    if [ "$enabled" = "false" ]; then
        return 0
    fi

    # Check docker settings
    local docker_enabled=$(yaml_get "docker.enabled" "$HOOKS_CONFIG")
    local docker_compose=$(yaml_get "docker.compose" "$HOOKS_CONFIG")
    local docker_container=$(yaml_get "docker.container" "$HOOKS_CONFIG")
    local compose_file=$(yaml_get "docker.compose_file" "$HOOKS_CONFIG")

    [ -z "$compose_file" ] && compose_file="docker-compose.yml"

    # Get commands
    local commands=$(yaml_get_commands "pre-commit" "$HOOKS_CONFIG")

    if [ -z "$commands" ]; then
        return 0
    fi

    echo ""
    echo -e "${CYAN}${BOLD}┌──────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${CYAN}${BOLD}│  Running pre-commit checks...                                │${NC}"
    echo -e "${CYAN}${BOLD}└──────────────────────────────────────────────────────────────┘${NC}"
    echo ""

    local failed=0

    while IFS= read -r line; do
        [ -z "$line" ] && continue

        local name="${line%%|*}"
        local cmd="${line#*|}"

        echo -e "${BLUE}▶${NC} ${WHITE}${BOLD}${name}${NC}"
        echo -e "  ${DIM}${cmd}${NC}"

        # Build the actual command
        local full_cmd="$cmd"

        if [ "$docker_enabled" = "true" ]; then
            if [ "$docker_compose" = "true" ]; then
                full_cmd="docker-compose -f $compose_file exec -T $docker_container $cmd"
            else
                full_cmd="docker exec $docker_container $cmd"
            fi
        fi

        # Run command
        cd "$PROJECT_ROOT" || exit 1

        if eval "$full_cmd"; then
            echo -e "  ${GREEN}✔ Passed${NC}"
        else
            echo -e "  ${RED}✖ Failed${NC}"
            failed=1
        fi
        echo ""

    done <<< "$commands"

    if [ $failed -eq 1 ]; then
        echo -e "${RED}${BOLD}┌──────────────────────────────────────────────────────────────┐${NC}"
        echo -e "${RED}${BOLD}│  ✖ COMMIT REJECTED - Pre-commit checks failed                │${NC}"
        echo -e "${RED}${BOLD}└──────────────────────────────────────────────────────────────┘${NC}"
        echo ""
        echo -e "${YELLOW}Fix the issues above and try again.${NC}"
        echo ""
        return 1
    fi

    echo -e "${GREEN}${BOLD}✔ All pre-commit checks passed${NC}"
    echo ""
    return 0
}

# ============================================================================
# PHPCS for PHP Projects (Drupal/WordPress)
# ============================================================================

run_phpcs_checks() {
    # Check if config.yml exists (PHP project config)
    if [ ! -f "$PHP_CONFIG" ]; then
        return 0
    fi

    # Read project type from config.yml
    PROJECT_TYPE=$(grep -E "^type:" "$PHP_CONFIG" | sed 's/type:[[:space:]]*//' | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')

    if [ -z "$PROJECT_TYPE" ]; then
        return 0
    fi

    # Get staged PHP files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(php|module|inc|install|theme|profile)$')

    if [ -z "$STAGED_FILES" ]; then
        return 0
    fi

    # Function to check if a command exists
    command_exists() {
        command -v "$1" >/dev/null 2>&1
    }

    # Function to find phpcs binary
    find_phpcs() {
        if [ -f "$PROJECT_ROOT/vendor/bin/phpcs" ]; then
            echo "$PROJECT_ROOT/vendor/bin/phpcs"
            return 0
        fi

        if command_exists phpcs; then
            echo "phpcs"
            return 0
        fi

        return 1
    }

    # Function to install Drupal coding standards
    install_drupal_standards() {
        echo -e "${BLUE}Installing Drupal coding standards...${NC}"

        if [ ! -f "$PROJECT_ROOT/composer.json" ]; then
            echo -e "${RED}Error: composer.json not found. Cannot install drupal/coder.${NC}"
            return 1
        fi

        cd "$PROJECT_ROOT" || exit 1

        if ! composer require --dev drupal/coder 2>/dev/null; then
            echo -e "${RED}Error: Failed to install drupal/coder${NC}"
            return 1
        fi

        PHPCS_BIN=$(find_phpcs)
        if [ -n "$PHPCS_BIN" ]; then
            $PHPCS_BIN --config-set installed_paths "$PROJECT_ROOT/vendor/drupal/coder/coder_sniffer" 2>/dev/null
        fi

        echo -e "${GREEN}Drupal coding standards installed successfully${NC}"
        return 0
    }

    # Function to check if Drupal standards are available
    check_drupal_standards() {
        PHPCS_BIN=$(find_phpcs)
        if [ -z "$PHPCS_BIN" ]; then
            return 1
        fi

        $PHPCS_BIN -i 2>/dev/null | grep -q "Drupal"
        return $?
    }

    # Function to install WordPress coding standards
    install_wordpress_standards() {
        echo -e "${BLUE}Installing WordPress coding standards...${NC}"

        if [ ! -f "$PROJECT_ROOT/composer.json" ]; then
            echo -e "${RED}Error: composer.json not found. Cannot install wp-coding-standards.${NC}"
            return 1
        fi

        cd "$PROJECT_ROOT" || exit 1

        if ! composer require --dev wp-coding-standards/wpcs dealerdirect/phpcodesniffer-composer-installer 2>/dev/null; then
            echo -e "${RED}Error: Failed to install WordPress coding standards${NC}"
            return 1
        fi

        echo -e "${GREEN}WordPress coding standards installed successfully${NC}"
        return 0
    }

    # Function to check if WordPress standards are available
    check_wordpress_standards() {
        PHPCS_BIN=$(find_phpcs)
        if [ -z "$PHPCS_BIN" ]; then
            return 1
        fi

        $PHPCS_BIN -i 2>/dev/null | grep -q "WordPress"
        return $?
    }

    # Determine standard based on project type
    case "$PROJECT_TYPE" in
        drupal)
            STANDARD="Drupal,DrupalPractice"
            CHECK_FUNC="check_drupal_standards"
            INSTALL_FUNC="install_drupal_standards"
            ;;
        wordpress)
            STANDARD="WordPress"
            CHECK_FUNC="check_wordpress_standards"
            INSTALL_FUNC="install_wordpress_standards"
            ;;
        *)
            return 0
            ;;
    esac

    # Find or install phpcs
    PHPCS_BIN=$(find_phpcs)

    if [ -z "$PHPCS_BIN" ]; then
        echo -e "${YELLOW}phpcs not found. Installing...${NC}"
        cd "$PROJECT_ROOT" || exit 1
        composer require --dev squizlabs/php_codesniffer 2>/dev/null
        PHPCS_BIN=$(find_phpcs)

        if [ -z "$PHPCS_BIN" ]; then
            echo -e "${RED}Error: Could not install phpcs${NC}"
            return 1
        fi
    fi

    # Check if standards are installed
    if ! $CHECK_FUNC; then
        $INSTALL_FUNC
        if ! $CHECK_FUNC; then
            echo -e "${RED}Error: Could not configure coding standards${NC}"
            return 1
        fi
    fi

    # Run phpcs on staged files
    echo -e "${BLUE}▶${NC} ${WHITE}${BOLD}PHPCS (${STANDARD})${NC}"
    echo ""

    ERRORS_FOUND=0
    FILES_CHECKED=0

    for FILE in $STAGED_FILES; do
        if [ -f "$PROJECT_ROOT/$FILE" ]; then
            FILES_CHECKED=$((FILES_CHECKED + 1))

            OUTPUT=$($PHPCS_BIN --standard="$STANDARD" --colors "$PROJECT_ROOT/$FILE" 2>&1)
            RESULT=$?

            if [ $RESULT -ne 0 ]; then
                ERRORS_FOUND=1
                echo "$OUTPUT"
                echo ""
            fi
        fi
    done

    if [ $ERRORS_FOUND -eq 1 ]; then
        echo ""
        echo -e "${RED}${BOLD}┌──────────────────────────────────────────────────────────────┐${NC}"
        echo -e "${RED}${BOLD}│  ✖ COMMIT REJECTED - PHPCS violations found                  │${NC}"
        echo -e "${RED}${BOLD}└──────────────────────────────────────────────────────────────┘${NC}"
        echo ""
        echo -e "${YELLOW}Please fix the coding standard violations above.${NC}"
        echo ""
        echo -e "${CYAN}Tip:${NC} Run ${GREEN}phpcbf${NC} to auto-fix some issues:"
        echo -e "  ${DIM}\$${NC} ./vendor/bin/phpcbf --standard=${STANDARD} <file>"
        echo ""
        return 1
    fi

    if [ $FILES_CHECKED -gt 0 ]; then
        echo -e "  ${GREEN}✔ All $FILES_CHECKED file(s) passed ${STANDARD} coding standards${NC}"
        echo ""
    fi

    return 0
}

# ============================================================================
# Main
# ============================================================================

# Run custom commands from .dev-hooks.yml
if ! run_custom_commands; then
    exit 1
fi

# Run PHPCS for PHP projects
if ! run_phpcs_checks; then
    exit 1
fi

exit 0
