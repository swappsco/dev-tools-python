#!/bin/bash

# Pre-push hook
# 1. Validates branch names (ClickUp ID or conventional format)
# 2. Runs custom commands from .dev-hooks.yml config file

# Colors optimized for macOS Terminal
RED='\x1b[31m'
GREEN='\x1b[32m'
YELLOW='\x1b[33m'
BLUE='\x1b[34m'
MAGENTA='\x1b[35m'
CYAN='\x1b[36m'
WHITE='\x1b[37m'
BOLD='\x1b[1m'
DIM='\x1b[2m'
NC='\x1b[0m'

# Get project root
PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
CONFIG_FILE="$PROJECT_ROOT/.dev-hooks.yml"

branch_name=$(git symbolic-ref --short HEAD)

# ============================================================================
# YAML Parser (simple, no dependencies)
# ============================================================================

# Get a simple value from yaml: yaml_get "key.subkey"
yaml_get() {
    local key="$1"
    local file="$2"

    if [ ! -f "$file" ]; then
        echo ""
        return
    fi

    # Handle nested keys like "docker.enabled"
    if [[ "$key" == *"."* ]]; then
        local parent="${key%%.*}"
        local child="${key#*.}"
        awk -v parent="$parent" -v child="$child" '
            $0 ~ "^"parent":" { in_section=1; next }
            in_section && /^[a-zA-Z]/ { in_section=0 }
            in_section && $0 ~ "^  "child":" {
                gsub(/^  [a-zA-Z_-]+:[ ]*/, "")
                gsub(/^["'\'']|["'\'']$/, "")
                gsub(/^[ \t]+|[ \t]+$/, "")
                print
                exit
            }
        ' "$file"
    else
        awk -v key="$key" '
            $0 ~ "^"key":" {
                gsub(/^[a-zA-Z_-]+:[ ]*/, "")
                gsub(/^["'\'']|["'\'']$/, "")
                gsub(/^[ \t]+|[ \t]+$/, "")
                print
                exit
            }
        ' "$file"
    fi
}

# Get list of commands from yaml
yaml_get_commands() {
    local file="$1"

    if [ ! -f "$file" ]; then
        return
    fi

    awk '
        /^pre-push:/ { in_prepush=1; next }
        in_prepush && /^[a-zA-Z]/ { in_prepush=0 }
        in_prepush && /^  commands:/ { in_commands=1; next }
        in_commands && /^  [a-zA-Z]/ { in_commands=0 }
        in_commands && /^    - name:/ {
            gsub(/^    - name:[ ]*/, "")
            gsub(/^["'\'']|["'\'']$/, "")
            name=$0
        }
        in_commands && /^      run:/ {
            gsub(/^      run:[ ]*/, "")
            gsub(/^["'\'']|["'\'']$/, "")
            print name "|" $0
        }
        in_commands && /^      allow_failure:/ {
            gsub(/^      allow_failure:[ ]*/, "")
            if ($0 == "true") allow_failure="true"
            else allow_failure="false"
        }
    ' "$file"
}

# ============================================================================
# Branch Validation
# ============================================================================

validate_branch() {
    local branch="$1"

    # Check if validation is disabled
    local skip_validation=$(yaml_get "pre-push.skip_branch_validation" "$CONFIG_FILE")
    if [ "$skip_validation" = "true" ]; then
        return 0
    fi

    # Allowed special branches
    local allowed_branches="^(master|main|develop|staging|production)$"

    # ClickUp pattern: CU- followed by alphanumeric characters
    local clickup_pattern="^CU-[a-zA-Z0-9]+$"

    # Conventional branch pattern: type/description
    local conventional_pattern="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|hotfix|release)/.+$"

    if echo "$branch" | grep -qE "$allowed_branches"; then
        return 0
    fi

    if echo "$branch" | grep -qE "$clickup_pattern"; then
        return 0
    fi

    if echo "$branch" | grep -qE "$conventional_pattern"; then
        return 0
    fi

    # Invalid branch name
    echo ""
    echo -e "${RED}${BOLD}┌──────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${RED}${BOLD}│  ✖ PUSH REJECTED - Invalid branch name                       │${NC}"
    echo -e "${RED}${BOLD}└──────────────────────────────────────────────────────────────┘${NC}"
    echo ""
    echo -e "${WHITE}${BOLD}Your branch:${NC}"
    echo -e "  ${DIM}\"${branch}\"${NC}"
    echo ""
    echo -e "${CYAN}${BOLD}Allowed formats:${NC}"
    echo ""
    echo -e "  ${WHITE}1. ClickUp ID:${NC}"
    echo -e "     ${MAGENTA}CU-xxxxxxxxx${NC}"
    echo -e "     ${DIM}\$ git checkout -b \"CU-86b7f42fd\"${NC}"
    echo ""
    echo -e "  ${WHITE}2. Conventional:${NC}"
    echo -e "     ${GREEN}<type>${NC}${DIM}/${NC}${WHITE}<description>${NC}"
    echo -e "     ${DIM}Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, hotfix, release${NC}"
    echo -e "     ${DIM}\$ git checkout -b \"feat/user-login\"${NC}"
    echo -e "     ${DIM}\$ git checkout -b \"fix/header-bug\"${NC}"
    echo ""
    echo -e "  ${WHITE}3. Special branches:${NC}"
    echo -e "     ${GREEN}master${NC}, ${GREEN}main${NC}, ${GREEN}develop${NC}, ${GREEN}staging${NC}, ${GREEN}production${NC}"
    echo ""
    return 1
}

# ============================================================================
# Run Custom Commands
# ============================================================================

run_commands() {
    if [ ! -f "$CONFIG_FILE" ]; then
        return 0
    fi

    # Check if pre-push is enabled
    local enabled=$(yaml_get "pre-push.enabled" "$CONFIG_FILE")
    if [ "$enabled" = "false" ]; then
        return 0
    fi

    # Check docker settings
    local docker_enabled=$(yaml_get "docker.enabled" "$CONFIG_FILE")
    local docker_compose=$(yaml_get "docker.compose" "$CONFIG_FILE")
    local docker_container=$(yaml_get "docker.container" "$CONFIG_FILE")
    local compose_file=$(yaml_get "docker.compose_file" "$CONFIG_FILE")

    [ -z "$compose_file" ] && compose_file="docker-compose.yml"

    # Get commands
    local commands=$(yaml_get_commands "$CONFIG_FILE")

    if [ -z "$commands" ]; then
        return 0
    fi

    echo ""
    echo -e "${CYAN}${BOLD}┌──────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${CYAN}${BOLD}│  Running pre-push checks...                                  │${NC}"
    echo -e "${CYAN}${BOLD}└──────────────────────────────────────────────────────────────┘${NC}"
    echo ""

    local failed=0

    while IFS= read -r line; do
        [ -z "$line" ] && continue

        local name="${line%%|*}"
        local cmd="${line#*|}"

        echo -e "${BLUE}▶${NC} ${WHITE}${BOLD}${name}${NC}"
        echo -e "  ${DIM}${cmd}${NC}"

        # Build the actual command
        local full_cmd="$cmd"

        if [ "$docker_enabled" = "true" ]; then
            if [ "$docker_compose" = "true" ]; then
                full_cmd="docker-compose -f $compose_file exec -T $docker_container $cmd"
            else
                full_cmd="docker exec $docker_container $cmd"
            fi
        fi

        # Run command
        cd "$PROJECT_ROOT" || exit 1

        if eval "$full_cmd"; then
            echo -e "  ${GREEN}✔ Passed${NC}"
        else
            echo -e "  ${RED}✖ Failed${NC}"
            failed=1
        fi
        echo ""

    done <<< "$commands"

    if [ $failed -eq 1 ]; then
        echo -e "${RED}${BOLD}┌──────────────────────────────────────────────────────────────┐${NC}"
        echo -e "${RED}${BOLD}│  ✖ PUSH REJECTED - Pre-push checks failed                    │${NC}"
        echo -e "${RED}${BOLD}└──────────────────────────────────────────────────────────────┘${NC}"
        echo ""
        echo -e "${YELLOW}Fix the issues above and try again.${NC}"
        echo ""
        return 1
    fi

    echo -e "${GREEN}${BOLD}✔ All pre-push checks passed${NC}"
    echo ""
    return 0
}

# ============================================================================
# Main
# ============================================================================

# Validate branch name
if ! validate_branch "$branch_name"; then
    exit 1
fi

# Run custom commands
if ! run_commands; then
    exit 1
fi

exit 0
